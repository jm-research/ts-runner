#ifndef TSCPP_UTILS_PATH_H
#define TSCPP_UTILS_PATH_H

#include <regex>
#include <string>

#include "tscpp/base/core.h"
#include "tscpp/utils/utf.h"

namespace tscpp {
using std::regex;
using std::replace;
using std::string;
using tscpp::utf::CharCode;

constexpr static auto directorySeparator = "/";
constexpr static auto altDirectorySeparator = "\\";
constexpr static auto urlSchemeSeparator = "://";
static const regex relativePathSegmentRegExp(
    "/(?:\\/\\/)|(?:^|\\/)\\.\\.?(?:$|\\/)/");

bool fileExtensionIs(const string& path, const string& extension);

bool fileExtensionIsOneOf(const string& path, const vector<string>& extensions);

bool fileExtensionIsOneOf(const string& path,
                          const vector<const char*>& extensions);

/**
 * Normalize path separators, converting `\` into `/`.
 */
string normalizeSlashes(const string& path);

//// Path Parsing
bool isVolumeCharacter(const CharCode& charCode);

int getFileUrlVolumeSeparatorEnd(const string& url, int start);

/**
 * Returns length of the root part of a path or URL (i.e. length of "/", "x:/",
 * "//server/share/, file:///user/files"). If the root is part of a URL, the
 * twos-complement of the root length is returned.
 */
int getEncodedRootLength(const string& path);

/**
 * Returns length of the root part of a path or URL (i.e. length of "/", "x:/",
 * "//server/share/, file:///user/files").
 *
 * For example:
 * ```ts
 * getRootLength("a") === 0                   // ""
 * getRootLength("/") === 1                   // "/"
 * getRootLength("c:") === 2                  // "c:"
 * getRootLength("c:d") === 0                 // ""
 * getRootLength("c:/") === 3                 // "c:/"
 * getRootLength("c:\\") === 3                // "c:\\"
 * getRootLength("//server") === 7            // "//server"
 * getRootLength("//server/share") === 8      // "//server/"
 * getRootLength("\\\\server") === 7          // "\\\\server"
 * getRootLength("\\\\server\\share") === 8   // "\\\\server\\"
 * getRootLength("file:///path") === 8        // "file:///"
 * getRootLength("file:///c:") === 10         // "file:///c:"
 * getRootLength("file:///c:d") === 8         // "file:///"
 * getRootLength("file:///c:/path") === 11    // "file:///c:/"
 * getRootLength("file://server") === 13      // "file://server"
 * getRootLength("file://server/path") === 14 // "file://server/"
 * getRootLength("http://server") === 13      // "http://server"
 * getRootLength("http://server/path") === 14 // "http://server/"
 * ```
 */
int getRootLength(const string& path);

/**
 * Determines whether a charCode corresponds to `/` or `\`.
 */
bool isAnyDirectorySeparator(const CharCode& charCode);

bool hasTrailingDirectorySeparator(const string& path);

string ensureTrailingDirectorySeparator(const string& path);

/**
 * Combines paths. If a path is absolute, it replaces any previous path.
 * Relative paths are not simplified.
 *
 * ```ts
 * // Non-rooted
 * combinePaths("path", "to", "file.ext") === "path/to/file.ext"
 * combinePaths("path", "dir", "..", "to", "file.ext") ===
 * "path/dir/../to/file.ext"
 * // POSIX
 * combinePaths("/path", "to", "file.ext") === "/path/to/file.ext"
 * combinePaths("/path", "/to", "file.ext") === "/to/file.ext"
 * // DOS
 * combinePaths("c:/path", "to", "file.ext") === "c:/path/to/file.ext"
 * combinePaths("c:/path", "c:/to", "file.ext") === "c:/to/file.ext"
 * // URL
 * combinePaths("file:///path", "to", "file.ext") === "file:///path/to/file.ext"
 * combinePaths("file:///path", "file:///to", "file.ext") ===
 * "file:///to/file.ext"
 * ```
 */
string combinePaths(string path, const vector<string>& paths);

vector<string> pathComponents(const string& path, int rootLength);

/**
 * Parse a path into an array containing a root component (at index 0) and zero
 * or more path components (at indices > 0). The result is not normalized. If
 * the path is relative, the root component is `""`. If the path is absolute,
 * the root component includes the first path separator (`/`).
 *
 * ```ts
 * // POSIX
 * getPathComponents("/path/to/file.ext") === ["/", "path", "to", "file.ext"]
 * getPathComponents("/path/to/") === ["/", "path", "to"]
 * getPathComponents("/") === ["/"]
 * // DOS
 * getPathComponents("c:/path/to/file.ext") === ["c:/", "path", "to",
 * "file.ext"] getPathComponents("c:/path/to/") === ["c:/", "path", "to"]
 * getPathComponents("c:/") === ["c:/"]
 * getPathComponents("c:") === ["c:"]
 * // URL
 * getPathComponents("http://typescriptlang.org/path/to/file.ext") ===
 * ["http://typescriptlang.org/", "path", "to", "file.ext"]
 * getPathComponents("http://typescriptlang.org/path/to/") ===
 * ["http://typescriptlang.org/", "path", "to"]
 * getPathComponents("http://typescriptlang.org/") ===
 * ["http://typescriptlang.org/"] getPathComponents("http://typescriptlang.org")
 * === ["http://typescriptlang.org"]
 * getPathComponents("file://server/path/to/file.ext") === ["file://server/",
 * "path", "to", "file.ext"] getPathComponents("file://server/path/to/") ===
 * ["file://server/", "path", "to"] getPathComponents("file://server/") ===
 * ["file://server/"] getPathComponents("file://server") === ["file://server"]
 * getPathComponents("file:///path/to/file.ext") === ["file:///", "path", "to",
 * "file.ext"] getPathComponents("file:///path/to/") === ["file:///", "path",
 * "to"] getPathComponents("file:///") === ["file:///"]
 * getPathComponents("file://") === ["file://"]
 */
vector<string> getPathComponents(const string& path,
                                 const string& currentDirectory = "");

/**
 * Formats a parsed path consisting of a root component (at index 0) and zero or
 * more path segments (at indices > 0).
 *
 * ```ts
 * getPathFromPathComponents(["/", "path", "to", "file.ext"]) ===
 * "/path/to/file.ext"
 * ```
 */
string getPathFromPathComponents(const vector<string>& pathComponents);

/**
 * Reduce an array of path components to a more simplified path by navigating
 * any
 * `"."` or `".."` entries in the path.
 */
vector<string> reducePathComponents(const vector<string>& components);

string normalizePath(string& _path);
}  // namespace tr

#endif  // TSCPP_UTILS_PATH_H